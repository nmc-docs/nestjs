"use strict";(self.webpackChunkreactjs=self.webpackChunkreactjs||[]).push([[242],{8398:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"websockets/websocket-middleware","title":"S\u1eed d\u1ee5ng middleware trong WebSocket","description":"Trong NestJS, middleware trong WebSocket \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 x\u1eed l\xfd c\xe1c y\xeau c\u1ea7u ho\u1eb7c s\u1ef1 ki\u1ec7n WebSocket tr\u01b0\u1edbc khi ch\xfang \u0111\u01b0\u1ee3c chuy\u1ec3n \u0111\u1ebfn c\xe1c handler (b\u1ed9 x\u1eed l\xfd) ho\u1eb7c \u0111\u1ec3 th\u1ef1c hi\u1ec7n c\xe1c t\xe1c v\u1ee5 nh\u01b0 x\xe1c th\u1ef1c, ghi log, ho\u1eb7c x\u1eed l\xfd d\u1eef li\u1ec7u \u0111\u1ea7u v\xe0o/\u0111\u1ea7u ra. Middleware trong WebSocket th\u01b0\u1eddng \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng \u0111\u1ec3:","source":"@site/docs/websockets/websocket-middleware.md","sourceDirName":"websockets","slug":"/websockets/websocket-middleware","permalink":"/nestjs/websockets/websocket-middleware","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"S\u1eed d\u1ee5ng Pipe, Exception Filter, Interceptor, Guard trong WebSocket Gateway","permalink":"/nestjs/websockets/websocket-pipe-exfilter-interceptor-guard"},"next":{"title":"T\u1ea1o exception filter cho app","permalink":"/nestjs/custom-exception-filter"}}');var c=t(4848),r=t(8453);const o={sidebar_position:4},s="S\u1eed d\u1ee5ng middleware trong WebSocket",l={},d=[{value:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng",id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng",level:2},{value:"V\xed d\u1ee5 s\u1eed d\u1ee5ng middleware \u0111\u1ec3 x\xe1c th\u1ef1c JWT",id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng-middleware-\u0111\u1ec3-x\xe1c-th\u1ef1c-jwt",level:2},{value:"V\xed d\u1ee5 s\u1eed d\u1ee5ng middleware \u0111\u1ec3 \u0111\u1ec3 gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i",id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng-middleware-\u0111\u1ec3-\u0111\u1ec3-gi\u1edbi-h\u1ea1n-s\u1ed1-l\u01b0\u1ee3ng-k\u1ebft-n\u1ed1i",level:2}];function a(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.header,{children:(0,c.jsx)(n.h1,{id:"s\u1eed-d\u1ee5ng-middleware-trong-websocket",children:"S\u1eed d\u1ee5ng middleware trong WebSocket"})}),"\n",(0,c.jsxs)(n.admonition,{title:"Gi\u1edbi thi\u1ec7u",type:"info",children:[(0,c.jsxs)(n.p,{children:["Trong NestJS, ",(0,c.jsx)(n.strong,{children:"middleware"})," trong WebSocket \u0111\u01b0\u1ee3c s\u1eed d\u1ee5ng \u0111\u1ec3 x\u1eed l\xfd c\xe1c y\xeau c\u1ea7u ho\u1eb7c s\u1ef1 ki\u1ec7n WebSocket tr\u01b0\u1edbc khi ch\xfang \u0111\u01b0\u1ee3c chuy\u1ec3n \u0111\u1ebfn c\xe1c handler (b\u1ed9 x\u1eed l\xfd) ho\u1eb7c \u0111\u1ec3 th\u1ef1c hi\u1ec7n c\xe1c t\xe1c v\u1ee5 nh\u01b0 x\xe1c th\u1ef1c, ghi log, ho\u1eb7c x\u1eed l\xfd d\u1eef li\u1ec7u \u0111\u1ea7u v\xe0o/\u0111\u1ea7u ra. Middleware trong WebSocket th\u01b0\u1eddng \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng \u0111\u1ec3:"]}),(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"X\xe1c th\u1ef1c (Authentication/Authorization):"})," Ki\u1ec3m tra xem client k\u1ebft n\u1ed1i WebSocket c\xf3 quy\u1ec1n truy c\u1eadp hay kh\xf4ng (v\xed d\u1ee5: ki\u1ec3m tra token JWT)."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Ghi log (Logging):"})," Ghi l\u1ea1i th\xf4ng tin v\u1ec1 k\u1ebft n\u1ed1i, ng\u1eaft k\u1ebft n\u1ed1i, ho\u1eb7c c\xe1c s\u1ef1 ki\u1ec7n WebSocket."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"X\u1eed l\xfd d\u1eef li\u1ec7u (Data Processing):"})," Bi\u1ebfn \u0111\u1ed5i ho\u1eb7c x\xe1c th\u1ef1c d\u1eef li\u1ec7u tr\u01b0\u1edbc khi chuy\u1ec3n \u0111\u1ebfn handler ho\u1eb7c t\u1eeb server \u0111\u1ebfn client."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Qu\u1ea3n l\xfd k\u1ebft n\u1ed1i:"})," Ki\u1ec3m so\xe1t tr\u1ea1ng th\xe1i k\u1ebft n\u1ed1i, nh\u01b0 t\u1eeb ch\u1ed1i k\u1ebft n\u1ed1i kh\xf4ng h\u1ee3p l\u1ec7 ho\u1eb7c gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i."]}),"\n"]})]}),"\n",(0,c.jsx)(n.h2,{id:"c\xe1ch-ho\u1ea1t-\u0111\u1ed9ng",children:"C\xe1ch ho\u1ea1t \u0111\u1ed9ng"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Trong NestJS, middleware WebSocket th\u01b0\u1eddng \u0111\u01b0\u1ee3c \xe1p d\u1ee5ng th\xf4ng qua c\xe1c ",(0,c.jsx)(n.strong,{children:"Gateway"})," ho\u1eb7c s\u1eed d\u1ee5ng c\xe1c decorator nh\u01b0 ",(0,c.jsx)(n.code,{children:"@WebSocketGateway"}),". Middleware c\xf3 th\u1ec3 \u0111\u01b0\u1ee3c g\u1eafn v\xe0o to\xe0n b\u1ed9 gateway ho\u1eb7c c\xe1c s\u1ef1 ki\u1ec7n c\u1ee5 th\u1ec3 (message events)."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng-middleware-\u0111\u1ec3-x\xe1c-th\u1ef1c-jwt",children:"V\xed d\u1ee5 s\u1eed d\u1ee5ng middleware \u0111\u1ec3 x\xe1c th\u1ef1c JWT"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"D\u01b0\u1edbi \u0111\xe2y l\xe0 m\u1ed9t v\xed d\u1ee5 v\u1ec1 vi\u1ec7c s\u1eed d\u1ee5ng middleware trong WebSocket \u0111\u1ec3 x\xe1c th\u1ef1c token JWT tr\u01b0\u1edbc khi cho ph\xe9p client k\u1ebft n\u1ed1i."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:'import {\n  WebSocketGateway,\n  WebSocketServer,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n} from "@nestjs/websockets";\nimport { Server, Socket, ExtendedError } from "socket.io";\nimport { Injectable, Logger } from "@nestjs/common";\nimport { verify } from "jsonwebtoken";\n\nimport { TokenService } from "src/modules/libs/token/token.service";\n\n// Middleware \u0111\u1ec3 x\xe1c th\u1ef1c token\n@Injectable()\nexport class AuthMiddleware {\n  constructor(private tokenService: TokenService) {}\n\n  async verifyClient(client: Socket, next: (err?: ExtendedError) => void) {\n    const [type, token] =\n      client.handshake.headers.authorization?.split(" ") ?? [];\n    const accessToken = type === "Bearer" && token ? token : undefined;\n    if (!accessToken) {\n      next(new Error("Token is required"));\n      return;\n    }\n    const accessTokenPayload = await this.tokenService.verifyAccessToken(\n      accessToken\n    );\n    if (!accessTokenPayload) {\n      next(new Error("Invalid token"));\n      return;\n    }\n    client.handshake.auth = accessTokenPayload;\n    next();\n  }\n}\n\n// WebSocket Gateway\n@WebSocketGateway()\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\n  @WebSocketServer()\n  server: Server;\n\n  private readonly logger = new Logger(ChatGateway.name);\n\n  constructor(private authMiddleware: AuthMiddleware) {}\n\n  // \xc1p d\u1ee5ng middleware cho to\xe0n b\u1ed9 gateway\n  afterInit(server: Server) {\n    this.server.use((client, next) => {\n      this.websocketMiddleware.verifyClient(client, next);\n    });\n  }\n\n  handleConnection(client: Socket) {\n    this.logger.log(`Client connected: ${client.id}`);\n    this.server.emit("message", `Welcome ${client.id}`);\n  }\n\n  handleDisconnect(client: Socket) {\n    this.logger.log(`Client disconnected: ${client.id}`);\n  }\n\n  @SubscribeMessage("message")\n  handleMessage(client: Socket, payload: string): void {\n    this.logger.log(`Message from ${client.id}: ${payload}`);\n    this.server.emit("message", `${client.id}: ${payload}`);\n  }\n}\n'})}),"\n",(0,c.jsx)(n.admonition,{title:"Gi\u1ea3i th\xedch",type:"note",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Ki\u1ec3m tra token JWT trong header c\u1ee7a client (",(0,c.jsx)(n.code,{children:"client.handshake.headers.authorization"}),")."]}),"\n",(0,c.jsxs)(n.li,{children:["N\u1ebfu token h\u1ee3p l\u1ec7, g\u1ecdi ",(0,c.jsx)(n.code,{children:"next()"})," \u0111\u1ec3 cho ph\xe9p k\u1ebft n\u1ed1i."]}),"\n",(0,c.jsxs)(n.li,{children:["N\u1ebfu token kh\xf4ng h\u1ee3p l\u1ec7 ho\u1eb7c kh\xf4ng t\u1ed3n t\u1ea1i, ng\u1eaft k\u1ebft n\u1ed1i client b\u1eb1ng ",(0,c.jsx)(n.code,{children:"client.disconnect()"}),"."]}),"\n"]})}),"\n",(0,c.jsx)(n.admonition,{title:"L\u01b0u \xfd",type:"caution",children:(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["X\xe1c th\u1ef1c JWT \u1edf ",(0,c.jsx)(n.strong,{children:"middleware"})," kh\xe1c so v\u1edbi ",(0,c.jsx)(n.strong,{children:"guard"})," \u1edf ch\u1ed7:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Middleware"}),": x\xe1c th\u1ef1c tr\u01b0\u1edbc r\u1ed3i m\u1edbi cho client k\u1ebft n\u1ed1i t\u1edbi websocket"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Guard"}),": client k\u1ebft n\u1ed1i t\u1edbi websocket th\xe0nh c\xf4ng -> x\xe1c th\u1ef1c JWT -> x\u1eed l\xfd event client g\u1eedi \u0111\u1ebfn"]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,c.jsx)(n.h2,{id:"v\xed-d\u1ee5-s\u1eed-d\u1ee5ng-middleware-\u0111\u1ec3-\u0111\u1ec3-gi\u1edbi-h\u1ea1n-s\u1ed1-l\u01b0\u1ee3ng-k\u1ebft-n\u1ed1i",children:"V\xed d\u1ee5 s\u1eed d\u1ee5ng middleware \u0111\u1ec3 \u0111\u1ec3 gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"D\u01b0\u1edbi \u0111\xe2y l\xe0 m\u1ed9t v\xed d\u1ee5 v\u1ec1 middleware trong NestJS WebSocket \u0111\u1ec3 gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i \u0111\u1ed3ng th\u1eddi \u0111\u1ebfn m\u1ed9t WebSocket Gateway. Middleware n\xe0y s\u1ebd ki\u1ec3m tra s\u1ed1 l\u01b0\u1ee3ng client hi\u1ec7n t\u1ea1i v\xe0 t\u1eeb ch\u1ed1i k\u1ebft n\u1ed1i m\u1edbi n\u1ebfu v\u01b0\u1ee3t qu\xe1 gi\u1edbi h\u1ea1n."}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-typescript",children:'import {\n  WebSocketGateway,\n  WebSocketServer,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n  SubscribeMessage,\n} from "@nestjs/websockets";\nimport { Injectable, Logger } from "@nestjs/common";\nimport { Socket, Server } from "socket.io";\n\n// Middleware \u0111\u1ec3 gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i\n@Injectable()\nexport class ConnectionLimitMiddleware {\n  private readonly logger = new Logger(ConnectionLimitMiddleware.name);\n  private readonly MAX_CONNECTIONS = 5; // Gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i \u0111\u1ed3ng th\u1eddi\n\n  constructor() {}\n\n  use(server: Server, client: Socket, next: () => void) {\n    const currentConnections = server.sockets.sockets.size;\n\n    if (currentConnections >= this.MAX_CONNECTIONS) {\n      this.logger.error(\n        `Connection limit reached. Rejecting client: ${client.id}`\n      );\n      client.emit("error", "Server is at maximum capacity");\n      client.disconnect(true);\n      return;\n    }\n\n    this.logger.log(\n      `New connection accepted: ${client.id}. Current connections: ${\n        currentConnections + 1\n      }`\n    );\n    next(); // Cho ph\xe9p k\u1ebft n\u1ed1i\n  }\n}\n\n@WebSocketGateway()\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\n  @WebSocketServer()\n  server: Server;\n\n  private readonly logger = new Logger(ChatGateway.name);\n\n  constructor(\n    private readonly connectionLimitMiddleware: ConnectionLimitMiddleware\n  ) {}\n\n  // \xc1p d\u1ee5ng middleware \u0111\u1ec3 gi\u1edbi h\u1ea1n s\u1ed1 l\u01b0\u1ee3ng k\u1ebft n\u1ed1i\n  afterInit(server: Server) {\n    server.use((socket, next) =>\n      this.connectionLimitMiddleware.use(server, socket, next)\n    );\n  }\n\n  handleConnection(client: Socket) {\n    this.logger.log(`Client connected: ${client.id}`);\n    this.server.emit("message", `Welcome ${client.id}`);\n  }\n\n  handleDisconnect(client: Socket) {\n    this.logger.log(`Client disconnected: ${client.id}`);\n  }\n\n  @SubscribeMessage("message")\n  handleMessage(client: Socket, payload: string): void {\n    this.logger.log(`Message from ${client.id}: ${payload}`);\n    this.server.emit("message", `${client.id}: ${payload}`);\n  }\n}\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(a,{...e})}):a(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>s});var i=t(6540);const c={},r=i.createContext(c);function o(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);