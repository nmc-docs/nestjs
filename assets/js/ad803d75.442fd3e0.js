"use strict";(self.webpackChunkreactjs=self.webpackChunkreactjs||[]).push([[389],{4081:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>i,default:()=>x,frontMatter:()=>r,metadata:()=>c,toc:()=>p});var s=n(4848),o=n(8453);const r={sidebar_position:10},i="T\u1ea1o exception filter cho app",c={id:"custom-exception-filter",title:"T\u1ea1o exception filter cho app",description:"- Tr\u01b0\u1edbc \u0111\xf3, ta \u0111\xe3 bi\u1ebft t\u1ea1o 1 Catch All Exception Filter, gi\u1edd ta s\u1ebd t\u1ea1o n\xf3 \u0111\u1ec3 x\u1eed l\xfd t\u1ea5t c\u1ea3 c\xe1c exception \u0111\u01b0\u1ee3c throw ra trong app m\u1ed9t c\xe1ch c\xf3 hi\u1ec7u qu\u1ea3.",source:"@site/docs/custom-exception-filter.md",sourceDirName:".",slug:"/custom-exception-filter",permalink:"/nestjs/custom-exception-filter",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"Gi\u1edbi thi\u1ec7u v\u1ec1 Websockets",permalink:"/nestjs/websockets/introduce"},next:{title:"Note v\u1ec1 NestJS",permalink:"/nestjs/nestjs-note"}},a={},p=[];function l(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",header:"header",li:"li",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"t\u1ea1o-exception-filter-cho-app",children:"T\u1ea1o exception filter cho app"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Tr\u01b0\u1edbc \u0111\xf3, ta \u0111\xe3 bi\u1ebft t\u1ea1o 1 ",(0,s.jsx)(t.a,{href:"./nestjs-fundamentals/exception-filters#catch-all-exception",children:"Catch All Exception Filter"}),", gi\u1edd ta s\u1ebd t\u1ea1o n\xf3 \u0111\u1ec3 x\u1eed l\xfd t\u1ea5t c\u1ea3 c\xe1c exception \u0111\u01b0\u1ee3c throw ra trong app m\u1ed9t c\xe1ch c\xf3 hi\u1ec7u qu\u1ea3."]}),"\n",(0,s.jsxs)(t.li,{children:["Exception filter ta s\u1ebd t\u1ea1o d\u01b0\u1edbi \u0111\xe2y s\u1ebd:","\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Tr\u1ea3 v\u1ec1 error cho client g\u1ed3m 3 tr\u01b0\u1eddng c\u1ed1 \u0111\u1ecbnh: ",(0,s.jsx)(t.strong,{children:"statusCode"}),", ",(0,s.jsx)(t.strong,{children:"message"}),", ",(0,s.jsx)(t.strong,{children:"path"}),", ",(0,s.jsx)(t.strong,{children:"details"})," (c\xf3 th\u1ec3 ",(0,s.jsx)(t.code,{children:"null"}),"), v\xe0 c\xf3 th\u1ec3 c\xf3 th\xeam c\xe1c tr\u01b0\u1eddng t\xf9y ch\u1ec9nh kh\xe1c."]}),"\n",(0,s.jsx)(t.li,{children:"N\u1ebfu m\xe3 l\u1ed7i tr\u1ea3 v\u1ec1 l\xe0 500, th\xec s\u1ebd tr\u1ea3 v\u1ec1 cho client c\xf3 d\u1ea1ng sau, v\xe0 \u1edf server s\u1ebd log ra chi ti\u1ebft l\u1ed7i \u0111\xf3:"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "statusCode": 500,\n  "message": "Internal server error",\n  "path": "/api/v1/auth/upload"\n}\n'})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["\u0110\u1ea7u ti\xean, t\u1ea1o ",(0,s.jsx)(t.strong,{children:"BaseExceptionResponse.dto.ts"}),":"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:'title="BaseExceptionResponse.dto.ts"',children:'import { Expose } from "class-transformer";\n\nexport class BaseExceptionResponse {\n  @Expose()\n  statusCode: number;\n\n  @Expose()\n  message: string;\n\n  @Expose()\n  details: any | null;\n\n  @Expose()\n  path: string;\n}\n'})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["T\u1ea1o ",(0,s.jsx)(t.strong,{children:"all-exception-filter.ts"}),":"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:'title="all-exception-filter.ts"',children:'import {\n  ArgumentsHost,\n  Catch,\n  ExceptionFilter,\n  HttpException,\n  HttpStatus,\n  Logger,\n} from "@nestjs/common";\nimport { WsException } from "@nestjs/websockets";\nimport { Request, Response } from "express";\nimport { Socket } from "socket.io";\n\nimport { BaseExceptionResponse } from "src/common/dto/BaseExceptionResponse.dto";\n\n@Catch()\nexport class AllExceptionsFilter implements ExceptionFilter {\n  private readonly logger = new Logger(AllExceptionsFilter.name);\n\n  catch(\n    exception: WsException | HttpException | Error,\n    host: ArgumentsHost\n  ): void {\n    const contextType = host.getType();\n\n    if (contextType === "http") {\n      this.handleHttpException(exception, host);\n    } else if (contextType === "ws") {\n      this.handleWsException(exception, host);\n    }\n\n    const isLoggableException =\n      !(exception instanceof WsException) &&\n      !(exception instanceof HttpException);\n\n    if (isLoggableException) {\n      this.logUnhandledException(exception, host);\n    }\n  }\n\n  private handleWsException(\n    exception: WsException | Error,\n    host: ArgumentsHost\n  ) {\n    const socketClient = host.switchToWs().getClient<Socket>();\n    const wsData = host.switchToWs().getData();\n    const pattern = host.switchToWs().getPattern();\n    const wsError = !(exception instanceof WsException)\n      ? "Internal server error"\n      : exception.getError();\n\n    const errorDetails =\n      wsError instanceof Object ? { ...wsError } : { message: wsError };\n    socketClient.emit("ws_exception", {\n      ...errorDetails,\n      id: socketClient.id,\n      pattern,\n      data: wsData,\n    });\n  }\n\n  private handleHttpException(\n    exception: HttpException | Error,\n    host: ArgumentsHost\n  ): void {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    let statusCode: number = HttpStatus.INTERNAL_SERVER_ERROR;\n    let message: string = "Internal server error";\n    let responseBody: BaseExceptionResponse = {\n      statusCode,\n      message,\n      path: request.url,\n      details: null,\n    };\n\n    if (exception instanceof HttpException) {\n      statusCode = exception.getStatus();\n      if (statusCode !== HttpStatus.INTERNAL_SERVER_ERROR) {\n        const exceptionResponseMessage: string | undefined = (\n          exception.getResponse() as any\n        ).message;\n        message = exceptionResponseMessage || "Unknown error message";\n\n        /* \n          - L\u1ea5y ra c\xe1c error fields kh\xe1c m\xe0 ta \u0111\xe3 th\xeam v\xe0o khi throw exception\n          - V\xed d\u1ee5: khi ta throw new BadRequestException({ errorType: \'INVALID_CREDENTIALS\', message: \'Invalid email\' }) th\xec extraErrorFields = { errorType: \'INVALID_CREDENTIALS\', message: \'Invalid email\' }\n        */\n        const { error, ...extraErrorFields } = exception.getResponse() as any;\n\n        responseBody = {\n          ...responseBody,\n          ...extraErrorFields,\n          message,\n          statusCode,\n        };\n      }\n    }\n\n    response.status(statusCode).json(responseBody);\n  }\n\n  private logUnhandledException(exception: Error, host: ArgumentsHost) {\n    const contextType = host.getType();\n\n    if (contextType === "http") {\n      const httpCtx = host.switchToHttp();\n      const request = httpCtx.getRequest<Request>();\n      this.logger.error(\n        `\\n\ud83d\udc49 Context type: ${contextType.toUpperCase()}\\n\ud83d\udc49 Method: ${\n          request.method\n        }\\n\ud83d\udc49 Path: ${request.url}\\n\ud83d\udc49 Details: ${exception.stack?.toString()}`\n      );\n    } else if (contextType === "ws") {\n      const wsCtx = host.switchToWs();\n      const pattern = wsCtx.getPattern();\n      this.logger.error(\n        `\\n\ud83d\udc49 Context type: ${contextType.toUpperCase()}\\n\ud83d\udc49 Pattern: ${pattern}\\n\ud83d\udc49 Details: ${exception.stack?.toString()}`\n      );\n    }\n  }\n}\n'})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Cu\u1ed1i c\xf9ng, \u1edf file ",(0,s.jsx)(t.strong,{children:"app.module.ts"}),":"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",metastring:'title="app.module.ts"',children:'import { APP_FILTER } from "@nestjs/core";\n\n@Module({\n  providers: [{ provide: APP_FILTER, useClass: AllExceptionsFilter }],\n})\nexport class AppModule {}\n'})}),"\n",(0,s.jsxs)(t.admonition,{type:"caution",children:[(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:'N\u1ebfu truy\u1ec1n 1 object khi throw exception (ho\u1eb7c custom exception). H\xe3y nh\u1edb lu\xf4n th\xeam tr\u01b0\u1eddng "message". \u0110i\u1ec1u n\xe0y l\xe0 b\u1eaft bu\u1ed9c.'}),"\n"]}),(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ts",children:'// \u274c Kh\xf4ng h\u1ee3p l\u1ec7\nthrow new BadRequestException({\n  errorType: ELoginExceptionErrorType.INVALID_2FA_OTP,\n});\n\n// \u2705 H\u1ee3p l\u1ec7\nthrow new BadRequestException({\n  message: "Two factor authenticator code is invalid",\n  errorType: ELoginExceptionErrorType.INVALID_2FA_OTP,\n});\n\n// \u2705 H\u1ee3p l\u1ec7 b\u1edfi v\xec truy\u1ec1n 1 string th\xec NestJS t\u1ef1 g\xe1n n\xf3 l\xe0 thu\u1ed9c t\xednh "message"\nthrow new BadRequestException("Two factor authenticator code is invalid");\n'})})]})]})}function x(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>c});var s=n(6540);const o={},r=s.createContext(o);function i(e){const t=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);