"use strict";(self.webpackChunkreactjs=self.webpackChunkreactjs||[]).push([[389],{6487:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"custom-exception-filter","title":"T\u1ea1o exception filter cho app","description":"- Trong b\xe0i n\xe0y, ta s\u1ebd t\u1ea1o 3 lo\u1ea1i exception filter:","source":"@site/docs/custom-exception-filter.md","sourceDirName":".","slug":"/custom-exception-filter","permalink":"/nestjs/custom-exception-filter","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10},"sidebar":"tutorialSidebar","previous":{"title":"Gi\u1edbi thi\u1ec7u v\u1ec1 Websockets","permalink":"/nestjs/websockets/introduce"},"next":{"title":"T\u1ea1o Logging cho app","permalink":"/nestjs/custom-app-logging"}}');var o=t(4848),r=t(8453);const i={sidebar_position:10},c="T\u1ea1o exception filter cho app",l={},p=[];function a(e){const n={admonition:"admonition",code:"code",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"t\u1ea1o-exception-filter-cho-app",children:"T\u1ea1o exception filter cho app"})}),"\n",(0,o.jsx)(n.admonition,{title:"M\u1ee5c ti\xeau",type:"info",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Trong b\xe0i n\xe0y, ta s\u1ebd t\u1ea1o 3 lo\u1ea1i exception filter:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Http Exception Filter"})," (X\u1eed l\xfd l\u1ed7i HTTP)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Websocket Exception Filter"})," (X\u1eed l\xfd l\u1ed7i Websocket)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Catch all Exception Filter"})," (X\u1eed l\xfd c\xe1c unhandled errors)"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"D\u1eef li\u1ec7u tr\u1ea3 v\u1ec1 l\u1ed7i c\u1ee7a HTTP bao g\u1ed3m c\xe1c tr\u01b0\u1eddng ch\xednh:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"statusCode"}),": M\xe3 l\u1ed7i HTTP"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"message"}),": Th\xf4ng b\xe1o l\u1ed7i"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"errors"}),": Chi ti\u1ebft l\u1ed7i (c\xf3 th\u1ec3 c\xf3 ho\u1eb7c kh\xf4ng)"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"path"}),": Endpoint c\u1ee7a API"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"D\u1eef li\u1ec7u tr\u1ea3 v\u1ec1 l\u1ed7i c\u1ee7a Websocket bao g\u1ed3m c\xe1c tr\u01b0\u1eddng ch\xednh:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"clientId"}),": ID c\u1ee7a client k\u1ebft n\u1ed1i t\u1edbi server socket"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"pattern"}),": Subscribe message"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"payload"}),": D\u1eef li\u1ec7u client g\u1eedi \u0111\u1ebfn"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"message"}),": Th\xf4ng b\xe1o l\u1ed7i"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"errors"}),": Chi ti\u1ebft l\u1ed7i (c\xf3 th\u1ec3 c\xf3 ho\u1eb7c kh\xf4ng)"]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\u0110\u1ea7u ti\xean, t\u1ea1o ",(0,o.jsx)(n.strong,{children:"BaseExceptionResponse.dto.ts"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="BaseExceptionResponse.dto.ts"',children:'import { Expose } from "class-transformer";\n\nexport class BaseExceptionResponse {\n  @Expose()\n  statusCode: number;\n\n  @Expose()\n  message: string;\n\n  @Expose()\n  errors: any | null;\n\n  @Expose()\n  path: string;\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["T\u1ea1o ",(0,o.jsx)(n.strong,{children:"http-exception-filter.ts"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="http-exception-filter.ts"',children:'import {\n  ArgumentsHost,\n  Catch,\n  ExceptionFilter,\n  HttpException,\n  HttpStatus,\n} from "@nestjs/common";\nimport { Request, Response } from "express";\n\nimport { BaseExceptionResponse } from "src/common/dto/BaseExceptionResponse.dto";\n\n@Catch(HttpException)\nexport class HttpExceptionFilter implements ExceptionFilter {\n  catch(exception: HttpException, host: ArgumentsHost) {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    let statusCode: number = HttpStatus.INTERNAL_SERVER_ERROR;\n    let message: string =\n      "An unexpected error occurred. Please contact admin to resolve this issue.";\n    let responseBody: BaseExceptionResponse = {\n      statusCode,\n      message,\n      path: request.url,\n      errors: null,\n    };\n\n    statusCode = exception.getStatus();\n    if (statusCode !== HttpStatus.INTERNAL_SERVER_ERROR) {\n      const exceptionResponseMessage: string | undefined = (\n        exception.getResponse() as any\n      ).message;\n      message = exceptionResponseMessage || "Unknown error message";\n\n      const { error, ...extraErrorFields } = exception.getResponse() as any;\n\n      responseBody = {\n        ...responseBody,\n        ...extraErrorFields,\n        message,\n        statusCode,\n      };\n    }\n\n    response.status(statusCode).json(responseBody);\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["T\u1ea1o ",(0,o.jsx)(n.strong,{children:"ws-exception-filter.ts"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="ws-exception-filter.ts"',children:'import { ArgumentsHost, Catch, ExceptionFilter } from "@nestjs/common";\nimport { WsException } from "@nestjs/websockets";\nimport { Socket } from "socket.io";\n\n@Catch(WsException)\nexport class WsExceptionFilter implements ExceptionFilter {\n  catch(exception: WsException, host: ArgumentsHost) {\n    const wsContext = host.switchToWs();\n    const socketClient = wsContext.getClient<Socket>();\n    const wsData = wsContext.getData();\n    const pattern = wsContext.getPattern();\n    const wsError = exception.getError();\n\n    const errorMessage =\n      (wsError instanceof Object ? (wsError as any)?.message : wsError) ||\n      "Unknown error message";\n\n    const errorResponse = {\n      ...(wsError instanceof Object ? wsError : {}),\n      clientId: socketClient.id,\n      pattern,\n      payload: wsData,\n      message: errorMessage,\n    };\n\n    socketClient.emit("ws_exception", errorResponse);\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["T\u1ea1o ",(0,o.jsx)(n.strong,{children:"all-exception.filter.ts"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="all-exception.filter.ts"',children:'import {\n  ArgumentsHost,\n  Catch,\n  ExceptionFilter,\n  HttpStatus,\n} from "@nestjs/common";\nimport { Request, Response } from "express";\nimport { Socket } from "socket.io";\n\nimport { BaseExceptionResponse } from "src/common/dto/BaseExceptionResponse.dto";\n\n@Catch()\nexport class AllExceptionsFilter implements ExceptionFilter {\n  catch(exception: Error, host: ArgumentsHost): void {\n    const contextType = host.getType();\n\n    if (contextType === "http") {\n      this.handleHttpException(exception, host);\n    } else if (contextType === "ws") {\n      this.handleWsException(exception, host);\n    }\n  }\n\n  private handleWsException(_exception: Error, host: ArgumentsHost) {\n    const socketClient = host.switchToWs().getClient<Socket>();\n    const wsData = host.switchToWs().getData();\n    const pattern = host.switchToWs().getPattern();\n\n    const responseBody = {\n      clientId: socketClient.id,\n      pattern,\n      payload: wsData,\n      message:\n        "An unexpected error occurred. Please contact admin to resolve this issue.",\n      errors: "Internal server error",\n    };\n\n    socketClient.emit("ws_exception", responseBody);\n  }\n\n  private handleHttpException(_exception: Error, host: ArgumentsHost): void {\n    const ctx = host.switchToHttp();\n    const response = ctx.getResponse<Response>();\n    const request = ctx.getRequest<Request>();\n\n    const responseBody: BaseExceptionResponse = {\n      statusCode: HttpStatus.INTERNAL_SERVER_ERROR,\n      message:\n        "An unexpected error occurred. Please contact admin to resolve this issue.",\n      path: request.url,\n      errors: "Internal server error",\n    };\n\n    response.status(HttpStatus.INTERNAL_SERVER_ERROR).json(responseBody);\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Cu\u1ed1i c\xf9ng, \u1edf file ",(0,o.jsx)(n.strong,{children:"app.module.ts"}),":"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",metastring:'title="app.module.ts"',children:'import { APP_FILTER } from "@nestjs/core";\n\n@Module({\n  providers: [\n    { provide: APP_FILTER, useClass: AllExceptionsFilter },\n    { provide: APP_FILTER, useClass: HttpExceptionFilter },\n    { provide: APP_FILTER, useClass: WsExceptionFilter },\n  ],\n})\nexport class AppModule {}\n'})}),"\n",(0,o.jsx)(n.admonition,{title:"Ch\xfa \xfd",type:"caution",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["L\u01b0u \xfd r\u1eb1ng ph\u1ea3i \u0111\u1eb7t ",(0,o.jsx)(n.code,{children:"HttpExceptionFilter"}),", ",(0,o.jsx)(n.code,{children:"WsExceptionFilter"})," sau ",(0,o.jsx)(n.code,{children:"AllExceptionsFilter"}),", \u0111i\u1ec1u n\xe0y l\xe0 r\u1ea5t quan tr\u1ecdng v\xec:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["NestJS s\u1ebd duy\u1ec7t qua t\u1eebng filter theo th\u1ee9 t\u1ef1 \u0111\u0103ng k\xfd (t\u1eeb cu\u1ed1i l\xean \u0111\u1ea7u), v\xe0 n\u1ebfu m\u1ed9t filter x\u1eed l\xfd \u0111\u01b0\u1ee3c l\u1ed7i (",(0,o.jsx)(n.code,{children:"catch"})," xong kh\xf4ng throw ti\u1ebfp), th\xec NestJS ",(0,o.jsx)(n.strong,{children:"kh\xf4ng chuy\u1ec3n l\u1ed7i cho filter ti\u1ebfp theo n\u1eefa"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Do \u0111\xf3, ",(0,o.jsx)(n.strong,{children:"filter n\xe0o khai b\xe1o sau s\u1ebd c\xf3 c\u01a1 h\u1ed9i x\u1eed l\xfd l\u1ed7i tr\u01b0\u1edbc"}),"."]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,o.jsx)(n.admonition,{title:"\u2705 G\u1ee3i \xfd s\u1eed d\u1ee5ng",type:"tip",children:(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\u0110\u1eb7t c\xe1c ",(0,o.jsx)(n.strong,{children:"filter chuy\xean bi\u1ec7t h\u01a1n"})," \u1edf ",(0,o.jsx)(n.strong,{children:"sau c\xf9ng"})," (\u0111\u01b0\u1ee3c \u01b0u ti\xean x\u1eed l\xfd tr\u01b0\u1edbc)."]}),"\n",(0,o.jsxs)(n.li,{children:["\u0110\u1eb7t c\xe1c ",(0,o.jsx)(n.strong,{children:"filter t\u1ed5ng qu\xe1t (catch-all)"})," nh\u01b0 ",(0,o.jsx)(n.code,{children:"AllExceptionsFilter"})," \u1edf ",(0,o.jsx)(n.strong,{children:"tr\u01b0\u1edbc"}),' (v\xec n\xf3 s\u1ebd n\u1eb1m d\u01b0\u1edbi c\xf9ng, \u0111\u01b0\u1ee3c g\u1ecdi cu\u1ed1i c\xf9ng nh\u01b0 m\u1ed9t "l\u01b0\u1edbi an to\xe0n").']}),"\n"]})}),"\n",(0,o.jsxs)(n.admonition,{type:"caution",children:[(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:'N\u1ebfu truy\u1ec1n 1 object khi throw exception (ho\u1eb7c custom exception). H\xe3y nh\u1edb lu\xf4n th\xeam tr\u01b0\u1eddng "message". \u0110i\u1ec1u n\xe0y l\xe0 b\u1eaft bu\u1ed9c.'}),"\n"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ts",children:'// \u274c Kh\xf4ng h\u1ee3p l\u1ec7\nthrow new BadRequestException({\n  errorType: ELoginExceptionErrorType.INVALID_2FA_OTP,\n});\n\n// \u2705 H\u1ee3p l\u1ec7\nthrow new BadRequestException({\n  message: "Two factor authenticator code is invalid",\n  errorType: ELoginExceptionErrorType.INVALID_2FA_OTP,\n});\n\n// \u2705 H\u1ee3p l\u1ec7 b\u1edfi v\xec truy\u1ec1n 1 string th\xec NestJS t\u1ef1 g\xe1n n\xf3 l\xe0 thu\u1ed9c t\xednh "message"\nthrow new BadRequestException("Two factor authenticator code is invalid");\n'})})]})]})}function d(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>c});var s=t(6540);const o={},r=s.createContext(o);function i(e){const n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);